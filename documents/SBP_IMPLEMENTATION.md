# ะกะะ ะธะฝัะตะณัะฐัะธั - ะัะพะณะธ ัะตะฐะปะธะทะฐัะธะธ

## โ ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ

### 1. ะกะตัะฒะธั ะกะะ (`backend/app/services/sbp_service.py`)

**ะคัะฝะบัะธะพะฝะฐะป:**
- โ ะกะพะทะดะฐะฝะธะต QR-ะบะพะดะพะฒ ะดะปั ะพะฟะปะฐัั
- โ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะปะฐัะตะถะตะน
- โ ะกะพะทะดะฐะฝะธะต ะฒะพะทะฒัะฐัะพะฒ ััะตะดััะฒ
- โ ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะฑะฐะฝะบะพะฒ ะกะะ
- โ ะัะพะฒะตัะบะฐ webhook ะฟะพะดะฟะธัะตะน
- โ Mock ัะตะถะธะผ ะดะปั ัะฐะทัะฐะฑะพัะบะธ

**ะะตัะพะดั:**
```python
sbp_service.create_qr_code(amount, description, order_id, customer_phone, ttl_minutes)
sbp_service.check_payment_status(qr_id)
sbp_service.create_refund(transaction_id, amount, reason)
sbp_service.get_available_banks()
sbp_service.verify_webhook_signature(payload, signature)
```

### 2. API ัะฝะดะฟะพะธะฝัั (`backend/app/api/payments.py`)

**ะะพะฒัะต ัะฝะดะฟะพะธะฝัั ะกะะ:**
- โ `POST /api/v1/payments/sbp/create-qr` - ะกะพะทะดะฐะฝะธะต QR-ะบะพะดะฐ
- โ `GET /api/v1/payments/sbp/check-status/{payment_id}` - ะัะพะฒะตัะบะฐ ััะฐัััะฐ
- โ `GET /api/v1/payments/sbp/banks` - ะกะฟะธัะพะบ ะฑะฐะฝะบะพะฒ
- โ `POST /api/v1/payments/sbp/webhook` - Webhook ะพั ะกะะ

**ะกััะตััะฒัััะธะต ัะฝะดะฟะพะธะฝัั (Stripe):**
- โ `POST /api/v1/payments/create-intent` - Stripe ะฟะปะฐััะถ
- โ `POST /api/v1/payments/confirm/{payment_id}` - ะะพะดัะฒะตัะถะดะตะฝะธะต
- โ `POST /api/v1/payments/refund/{payment_id}` - ะะพะทะฒัะฐั
- โ `GET /api/v1/payments/history` - ะััะพัะธั
- โ `POST /api/v1/payments/webhook` - Stripe webhook

### 3. ะะพะฝัะธะณััะฐัะธั (`backend/app/config.py`)

**ะะพะฑะฐะฒะปะตะฝั ะฝะฐัััะพะนะบะธ:**
```python
SBP_MERCHANT_ID: str = ""
SBP_API_KEY: str = ""
SBP_SECRET_KEY: str = ""
SBP_API_URL: str = "https://api.sbp.ru/v1"
```

### 4. ะะพะบัะผะตะฝัะฐัะธั

- โ `backend/SBP_API.md` - ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั API ะกะะ
- โ `TESTING_PAYMENTS.md` - ะัะบะพะฒะพะดััะฒะพ ะฟะพ ัะตััะธัะพะฒะฐะฝะธั ะพะฑะพะธั ะผะตัะพะดะพะฒ

---

## ๐ฏ ะัะตะธะผััะตััะฒะฐ ะกะะ

| ะฅะฐัะฐะบัะตัะธััะธะบะฐ | ะะฝะฐัะตะฝะธะต |
|----------------|----------|
| ะะพะผะธััะธั ะดะปั ะบะปะธะตะฝัะฐ | **0%** |
| ะะพะผะธััะธั ะดะปั ะผะตััะฐะฝัะฐ | ~0.4-0.7% |
| ะกะบะพัะพััั ะทะฐัะธัะปะตะฝะธั | **ะะณะฝะพะฒะตะฝะฝะพ** |
| ะะพะดะดะตัะถะบะฐ ะฑะฐะฝะบะพะฒ | 100+ ะฑะฐะฝะบะพะฒ ะะค |
| ะะตะณัะปะธัะพะฒะฐะฝะธะต | ะฆะ ะะค |
| ะะพัััะฟะฝะพััั | **24/7** |

**ะกัะฐะฒะฝะตะฝะธะต ั ะดััะณะธะผะธ ะผะตัะพะดะฐะผะธ:**

| | ะกะะ | Stripe | ะะฐััั ะฝะฐะฟััะผัั |
|---|-----|--------|----------------|
| ๐ท๐บ ะะพััะธั | โ ะะดะตะฐะปัะฝะพ | โ๏ธ ะะณัะฐะฝะธัะตะฝะพ | โ ะะฐะฑะพัะฐะตั |
| ๐ ะะตะถะดัะฝะฐัะพะดะฝัะต | โ ะะตั | โ ะะฐ | โ ะะฐ |
| ๐ฐ ะะพะผะธััะธั | ~0.5% | ~2.9% + $0.30 | ~2-3% |
| โก ะกะบะพัะพััั | ะะณะฝะพะฒะตะฝะฝะพ | 1-7 ะดะฝะตะน | 1-3 ะดะฝั |
| ๐ ะะตะทะพะฟะฐัะฝะพััั | ะฆะ ะะค | PCI DSS | PCI DSS |

---

## ๐ ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

### ะะปะธะตะฝััะบะธะน ัะปะพั:

```
1. ะะพะปัะทะพะฒะฐัะตะปั ะฒัะฑะธัะฐะตั "ะะฟะปะฐัะธัั ัะตัะตะท ะกะะ"
   โ
2. Frontend ะทะฐะฟัะฐัะธะฒะฐะตั POST /sbp/create-qr
   โ
3. Backend ัะพะทะดะฐัั QR-ะบะพะด ะธ ะฒะพะทะฒัะฐัะฐะตั:
   - QR ะธะทะพะฑัะฐะถะตะฝะธะต (base64)
   - URL ะดะปั deeplink
   - payment_id
   โ
4. Frontend ะพัะพะฑัะฐะถะฐะตั QR-ะบะพะด
   โ
5. ะะพะปัะทะพะฒะฐัะตะปั ัะบะฐะฝะธััะตั QR ะฒ ะฟัะธะปะพะถะตะฝะธะธ ะฑะฐะฝะบะฐ
   โ
6. ะะพะดัะฒะตัะถะดะฐะตั ะพะฟะปะฐัั ะฒ ะฑะฐะฝะบะต (Face ID/ะพัะฟะตัะฐัะพะบ)
   โ
7. ะกะะ ะพัะฟัะฐะฒะปัะตั webhook ะฝะฐ backend
   โ
8. Backend ะพะฑะฝะพะฒะปัะตั ััะฐััั โ "completed"
   โ
9. Frontend ะฟัะพะฒะตััะตั ััะฐััั (polling GET /check-status)
   โ
10. ะะพะบะฐะทัะฒะฐะตั ััะฟะตั ะธ ัะฐะทะฑะปะพะบะธััะตั ะดะพัััะฟ
```

### ะขะตัะฝะธัะตัะบะธะน ัะปะพั:

```python
# 1. ะกะพะทะดะฐะฝะธะต QR
response = await fetch('/api/v1/payments/sbp/create-qr', {
  method: 'POST',
  body: JSON.stringify({
    amount: 5000,  // 50 ััะฑะปะตะน
    session_id: 1,
    mentor_id: 2,
  })
});

const { qr_image, payment_id } = await response.json();

// 2. ะัะพะฑัะฐะถะตะฝะธะต QR
<img src={qr_image} alt="QR ะดะปั ะพะฟะปะฐัั" />

// 3. Polling ััะฐัััะฐ
const checkStatus = setInterval(async () => {
  const status = await fetch(`/api/v1/payments/sbp/check-status/${payment_id}`);
  const data = await status.json();
  
  if (data.status === 'completed') {
    clearInterval(checkStatus);
    showSuccess('ะะฟะปะฐัะตะฝะพ!');
  }
}, 3000); // ะบะฐะถะดัะต 3 ัะตะบัะฝะดั
```

---

## ๐ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโ
โ   Frontend  โโโโโโโโถโ   Backend    โโโโโโโโถโ  ะกะะ API    โ
โ  (Next.js)  โ       โ  (FastAPI)   โ       โ  (ะะกะะ)     โ
โโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโ
      โ                      โ                      โ
      โ 1. create-qr         โ 1. create QR         โ
      โโโโโโโโโโโโโโโโโโโโโโโถโโโโโโโโโโโโโโโโโโโโโโโถโ
      โ                      โ                      โ
      โ 2. qr_image          โ 2. qr_id, url        โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      โ                      โ                      โ
      โ 3. User scans QR     โ                      โ
      โ                      โ 4. webhook           โ
      โ                      โโโโโโโโโโโโโโโโโโโโโโโโ
      โ                      โ                      โ
      โ 5. check-status      โ 5. status query      โ
      โโโโโโโโโโโโโโโโโโโโโโโถโโโโโโโโโโโโโโโโโโโโโโโถโ
      โ                      โ                      โ
      โ 6. completed         โ 6. status            โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ง ะะตะถะธะผั ัะฐะฑะพัั

### Mock ัะตะถะธะผ (ัะตะบััะธะน)

**ะะบัะธะฒะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะบะพะณะดะฐ:**
- ะกะะ ะบะปััะธ ะฝะต ะฝะฐัััะพะตะฝั ะฒ `.env`
- ะะธะฑะปะธะพัะตะบะฐ `requests` ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ

**ะะพะฒะตะดะตะฝะธะต:**
- โ ะะพะทะฒัะฐัะฐะตั ัะตััะพะฒัะต QR-ะบะพะดั
- โ ะัะต ะฟะปะฐัะตะถะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ "completed"
- โ ะกะฟะธัะพะบ ะฑะฐะฝะบะพะฒ - ะผะพะบะพะฒัะน
- โ Webhook ัะฐะฑะพัะฐะตั ะปะพะบะฐะปัะฝะพ
- โ ะะพะณะธ ะฟะพะผะตัะตะฝั "MOCK MODE"

**ะัะตะธะผััะตััะฒะฐ:**
- ะะพะถะฝะพ ัะฐะทัะฐะฑะฐััะฒะฐัั ะฑะตะท ัะตะฐะปัะฝะพะณะพ ะกะะ ะฐะบะบะฐัะฝัะฐ
- ะััััะพะต ัะตััะธัะพะฒะฐะฝะธะต ัะปะพั
- ะะต ะฝัะถะฝั ัะตััะพะฒัะต ะบะฐััั

### Production ัะตะถะธะผ

**ะะปั ะฐะบัะธะฒะฐัะธะธ:**

1. **ะฃััะฐะฝะพะฒะธัะต ะฑะธะฑะปะธะพัะตะบั:**
```bash
pip install requests
```

2. **ะะพะปััะธัะต ะบะปััะธ ะกะะ** ะฒ ะฑะฐะฝะบะต (ะกะฑะตัะฑะฐะฝะบ, ะขะธะฝัะบะพัั, ะะพะดัะปัะฑะฐะฝะบ ะธ ะดั.)

3. **ะะพะฑะฐะฒััะต ะฒ `backend/.env`:**
```env
SBP_MERCHANT_ID=your_merchant_id_from_bank
SBP_API_KEY=your_api_key_from_bank
SBP_SECRET_KEY=your_secret_key_from_bank
SBP_API_URL=https://api.sbp.ru/v1
```

4. **ะะฐัััะพะนัะต webhook URL** ะฒ ะปะธัะฝะพะผ ะบะฐะฑะธะฝะตัะต ะกะะ:
```
https://your-domain.com/api/v1/payments/sbp/webhook
```

5. **ะะตัะตะทะฐะฟัััะธัะต backend**

---

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### Swagger UI

1. ะัะบัะพะนัะต http://127.0.0.1:8000/docs
2. ะะฒัะพัะธะทัะนัะตัั (Authorize ั Bearer token)
3. ะะฐะนะดะธัะต ัะตะบัะธั **Payments**
4. ะะพะฟัะพะฑัะนัะต ัะฝะดะฟะพะธะฝัั:
   - `POST /api/v1/payments/sbp/create-qr`
   - `GET /api/v1/payments/sbp/check-status/{payment_id}`
   - `GET /api/v1/payments/sbp/banks`

### cURL

```bash
# ะกะฟะธัะพะบ ะฑะฐะฝะบะพะฒ (ะฑะตะท ะฐะฒัะพัะธะทะฐัะธะธ)
curl http://127.0.0.1:8000/api/v1/payments/sbp/banks

# ะกะพะทะดะฐัั QR (ั ะฐะฒัะพัะธะทะฐัะธะตะน)
curl -X POST http://127.0.0.1:8000/api/v1/payments/sbp/create-qr \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 5000,
    "description": "ะะฟะปะฐัะฐ ัะตััะธะธ",
    "session_id": 1,
    "mentor_id": 2
  }'

# ะัะพะฒะตัะธัั ััะฐััั
curl http://127.0.0.1:8000/api/v1/payments/sbp/check-status/5 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

**Backend ะทะฐะฟััะตะฝ:** โ http://127.0.0.1:8000  
**Swagger UI:** โ http://127.0.0.1:8000/docs  
**Mock ัะตะถะธะผ:** โ ะะบัะธะฒะตะฝ

**ะะพะณ ะฟัะธ ะทะฐะฟััะบะต:**
```
โ๏ธ SBP service running in MOCK mode
โ Payment routes loaded
```

**ะัะพะฒะตัััะต:**
1. ะกะฟะธัะพะบ ะฑะฐะฝะบะพะฒ ัะฐะฑะพัะฐะตั
2. ะกะพะทะดะฐะฝะธะต QR ะฒะพะทะฒัะฐัะฐะตั ะดะฐะฝะฝัะต
3. ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฒะพะทะฒัะฐัะฐะตั "completed"
4. ะััะพัะธั ะฟะปะฐัะตะถะตะน ะฟะพะบะฐะทัะฒะฐะตั ะทะฐะฟะธัะธ

---

## ๐ ะะพะบัะผะตะฝัะฐัะธั

| ะคะฐะนะป | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `backend/SBP_API.md` | ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั API ะกะะ |
| `backend/PAYMENTS_API.md` | ะะพะบัะผะตะฝัะฐัะธั Stripe API |
| `TESTING_PAYMENTS.md` | ะัะบะพะฒะพะดััะฒะพ ะฟะพ ัะตััะธัะพะฒะฐะฝะธั |
| `backend/app/services/sbp_service.py` | ะะพะด ัะตัะฒะธัะฐ ะกะะ |
| `backend/app/api/payments.py` | ะะพะด API ัะฝะดะฟะพะธะฝัะพะฒ |

---

## ๐ฏ ะัะพะณะธ

### ะะตะฐะปะธะทะพะฒะฐะฝะพ:
- โ ะะพะปะฝัะน ัะตัะฒะธั ะกะะ ั 5 ะผะตัะพะดะฐะผะธ
- โ 4 ะฝะพะฒัั API ัะฝะดะฟะพะธะฝัะฐ
- โ Mock ัะตะถะธะผ ะดะปั ัะฐะทัะฐะฑะพัะบะธ
- โ Webhook ะพะฑัะฐะฑะพัะบะฐ
- โ ะะฝัะตะณัะฐัะธั ั ัััะตััะฒัััะตะน ัะธััะตะผะพะน ะฟะปะฐัะตะถะตะน
- โ ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

### ะขะตะฟะตัั ะฟะปะฐััะพัะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั:
1. **ะกะะ** - ะดะปั ัะพััะธะนัะบะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน (0% ะบะพะผะธััะธั, ะผะณะฝะพะฒะตะฝะฝะพ)
2. **Stripe** - ะดะปั ะผะตะถะดัะฝะฐัะพะดะฝัั ะฟะปะฐัะตะถะตะน (ะบะฐััั ะฒัะตั ัััะฐะฝ)

### ะัะตะธะผััะตััะฒะฐ ะดะปั ะฑะธะทะฝะตัะฐ:
- โ ะญะบะพะฝะพะผะธั ะฝะฐ ะบะพะผะธััะธัั (~2% ัะฐะทะฝะธัะฐ)
- โ ะะณะฝะพะฒะตะฝะฝะพะต ะทะฐัะธัะปะตะฝะธะต ััะตะดััะฒ
- โ ะฃะดะพะฑััะฒะพ ะดะปั ัะพััะธะนัะบะธั ะบะปะธะตะฝัะพะฒ
- โ ะกะพะพัะฒะตัััะฒะธะต ััะตะฑะพะฒะฐะฝะธัะผ ะฆะ ะะค
- โ ะะพะดะดะตัะถะบะฐ 100+ ะฑะฐะฝะบะพะฒ

### ะะพัะพะฒะพ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั:
- โ Mock ัะตะถะธะผ - ะฟััะผะพ ัะตะนัะฐั
- โ Production - ะฟะพัะปะต ะฟะพะปััะตะฝะธั ะบะปััะตะน ะพั ะฑะฐะฝะบะฐ

---

## ๐ ะกะปะตะดัััะธะต ัะฐะณะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### Frontend:
- [ ] ะะพะผะฟะพะฝะตะฝั ะดะปั ะพัะพะฑัะฐะถะตะฝะธั QR-ะบะพะดะฐ
- [ ] UI ะฒัะฑะพัะฐ ัะฟะพัะพะฑะฐ ะพะฟะปะฐัั (ะกะะ/Stripe/ะะฐััะฐ)
- [ ] ะะฝะธะผะฐัะธั ะพะถะธะดะฐะฝะธั ะพะฟะปะฐัั
- [ ] Push-ัะฒะตะดะพะผะปะตะฝะธั ะพะฑ ััะฟะตัะฝะพะน ะพะฟะปะฐัะต

### Backend:
- [ ] Email ัะฒะตะดะพะผะปะตะฝะธั ะพะฑ ะพะฟะปะฐัะต
- [ ] ะะฝะฐะปะธัะธะบะฐ ะฟะพ ะผะตัะพะดะฐะผ ะพะฟะปะฐัั
- [ ] ะะฒัะพะผะฐัะธัะตัะบะธะต ะฐะบัั ะธ ัะตะบะธ
- [ ] ะะฝัะตะณัะฐัะธั ั ะฑััะณะฐะปัะตัะธะตะน

### DevOps:
- [ ] ะะฐัััะพะนะบะฐ production webhook URL
- [ ] ะะพะฝะธัะพัะธะฝะณ ะฟะปะฐัะตะถะตะน (Sentry)
- [ ] ะะปะตััั ะฝะฐ failed ะฟะปะฐัะตะถะธ
- [ ] Backup ะฟะปะฐััะถะฝัั ะดะฐะฝะฝัั

---

## ๐ ะะพะดะดะตัะถะบะฐ

**API ะะพะบัะผะตะฝัะฐัะธั:**
- Swagger UI: http://127.0.0.1:8000/docs
- ะกะะ API: `backend/SBP_API.md`

**ะัะธัะธะฐะปัะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ะกะะ:**
- https://sbp.nspk.ru/
- https://sbp.nspk.ru/merchants/

**ะะฐะฝะบะธ ะดะปั ะฟะพะดะบะปััะตะฝะธั:**
- ะกะฑะตัะฑะฐะฝะบ ะะธะทะฝะตั: https://www.sberbank.ru/ru/s_m_business
- ะขะธะฝัะบะพัั ะะธะทะฝะตั: https://www.tinkoff.ru/business/
- ะะพะดัะปัะฑะฐะฝะบ: https://modulbank.ru/
- ะขะพัะบะฐ ะะฐะฝะบ: https://tochka.com/

---

## โ ะะพัะพะฒะพ! ๐

**ะะปะฐััะพัะผะฐ MentorHub ัะตะฟะตัั ะฟะพะดะดะตัะถะธะฒะฐะตั:**
- โ Stripe (ะผะตะถะดัะฝะฐัะพะดะฝัะต ะฟะปะฐัะตะถะธ)
- โ ะกะะ (ัะพััะธะนัะบะธะต ะฟะปะฐัะตะถะธ)
- โ Mock ัะตะถะธะผ ะดะปั ะพะฑะพะธั
- โ ะะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั

**ะะพะถะฝะพ ัะตััะธัะพะฒะฐัั ะฟััะผะพ ัะตะนัะฐั ัะตัะตะท Swagger UI! ๐**
